CREATE TABLE `bads-7105-308315.supermarket.CLV_CHURN_ALT` AS
SELECT  MONTH_YEAR,
        TOTAL_CUST_MONTH,
        TOTAL_CHURN_MONTH AS NO_CHURN_END,
        LAG(TOTAL_CUST_MONTH,3) OVER (ORDER BY MONTH_YEAR) AS NO_CUST_START,
        ROUND(TOTAL_CHURN_MONTH / LAG(TOTAL_CUST_MONTH,3) OVER (ORDER BY MONTH_YEAR),4) AS CHURN_RATE,
        ROUND(1/(TOTAL_CHURN_MONTH / LAG(TOTAL_CUST_MONTH,3) OVER (ORDER BY MONTH_YEAR)),2) AS ALT
FROM (
        SELECT  DISTINCT MONTH_YEAR,
                SUM(CASE WHEN CUST_TYPE != 'CHURN'THEN NO_CUST END) OVER (PARTITION BY MONTH_YEAR)  AS TOTAL_CUST_MONTH,
                SUM(CASE WHEN CUST_TYPE = 'CHURN'THEN NO_CUST END) OVER (PARTITION BY MONTH_YEAR)  AS TOTAL_CHURN_MONTH,
        FROM `bads-7105-308315.supermarket.CLV_CUSTOMER_MOVEMENT`
      )

ORDER BY MONTH_YEAR